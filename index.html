<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Correlation Matrix</title>
    <!-- Include the chart.js and chartjs-chart-matrix libraries -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-chart-matrix@1.2.0"></script>
    <!-- Include the chartjs-plugin-datalabels library for displaying the correlation values -->
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <style>
        body {
            font-family: sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin: 40px;
            background-color: #f0f4f8;
        }
        h2 {
            text-align: center;
            color: #2c3e50;
        }
        canvas {
            max-width: 800px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #ffffff;
            padding: 10px;
        }
    </style>
</head>
<body>
    <h2>5-Year Correlation Matrix</h2>
    <canvas id="heatmap"></canvas>

    <script>
        async function fetchCorrelationData() {
            const response = await fetch('http://localhost:8000/correlation');
            if (!response.ok) {
                // Display a message on the page instead of using an alert
                const canvas = document.getElementById('heatmap');
                canvas.style.display = 'none';
                const message = document.createElement('p');
                message.textContent = "Failed to fetch correlation data. Please ensure the backend is running.";
                message.style.cssText = "color: red; font-size: 1.2em; text-align: center;";
                document.body.appendChild(message);
                return null;
            }
            return response.json();
        }

        function prepareMatrixData(data) {
            const labels = Object.keys(data);
            const matrix = [];

            for (let row = 0; row < labels.length; row++) {
                for (let col = 0; col < labels.length; col++) {
                    const x = labels[col];
                    // Flip Y axis so matrix displays intuitively
                    const y = labels[labels.length - row - 1];
                    const v = data[y][x];
                    matrix.push({ x, y, v });
                }
            }
            return { labels, matrix };
        }

        async function renderMatrix() {
            const data = await fetchCorrelationData();
            if (!data) return;

            const { labels, matrix } = prepareMatrixData(data);

            const ctx = document.getElementById("heatmap").getContext("2d");

            new Chart(ctx, {
                type: 'matrix',
                data: {
                    datasets: [{
                        label: 'Correlation',
                        data: matrix,
                        width: ({ chart }) => (chart.chartArea?.width ?? 0) / labels.length - 2,
                        height: ({ chart }) => (chart.chartArea?.height ?? 0) / labels.length - 2,
                        backgroundColor: ctx => {
                            const value = ctx.raw.v;
                            const alpha = Math.abs(value);
                            // Use a diverging color scale: red for negative, white for zero, blue for positive
                            if (value < 0) {
                                // Interpolate from white (rgb 255,255,255) to red (rgb 255,0,0)
                                const c = Math.round(255 * (1 - alpha));
                                return `rgb(255, ${c}, ${c})`;
                            } else {
                                // Interpolate from white (rgb 255,255,255) to blue (rgb 0,0,255)
                                const c = Math.round(255 * (1 - alpha));
                                return `rgb(${c}, ${c}, 255)`;
                            }
                        },
                        borderWidth: 1,
                        borderColor: 'white'
                    }]
                },
                options: {
                    maintainAspectRatio: true,
                    responsive: true,
                    plugins: {
                        tooltip: {
                            callbacks: {
                                label: ctx => {
                                    const { x, y, v } = ctx.raw;
                                    return `${y} vs ${x}: ${v.toFixed(2)}`;
                                }
                            }
                        },
                        legend: { display: false },
                        title: { display: false },
                        datalabels: {
                            color: ctx => {
                                // Dynamically set font color for readability
                                const value = ctx.dataset.data[ctx.dataIndex].v;
                                // Use white text for high correlation (darker background) and black for low (lighter background)
                                return Math.abs(value) > 0.6 ? 'white' : 'black';
                            },
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: (value) => {
                                return value.v.toFixed(2);
                            }
                        }
                    },
                    layout: {
                        padding: 30
                    },
                    scales: {
                        x: {
                            type: 'category',
                            labels: labels,
                            position: 'top',
                            offset: true,
                            grid: { display: false },
                            ticks: {
                                font: { size: 14, weight: 'bold' },
                                color: '#000',
                                maxRotation: 60,
                                minRotation: 60,
                                padding: 10,
                                align: 'start',
                                crossAlign: 'far'
                            },
                            afterFit: scale => {
                                scale.paddingTop = 30;
                            }
                        },
                        y: {
                            type: 'category',
                            labels: labels.slice().reverse(),
                            offset: true,
                            grid: { display: false },
                            ticks: {
                                font: { size: 14, weight: 'bold' },
                                color: '#000',
                                padding: 15,
                                align: 'right',
                                crossAlign: 'far',
                            },
                            afterFit: scale => {
                                scale.paddingLeft = 40;
                            }
                        }
                    },
                    animation: false,
                    elements: {
                        rectangle: {
                            borderRadius: 0
                        }
                    },
                },
                // Register the datalabels plugin
                plugins: [ChartDataLabels]
            });
        }
        
        window.onload = function() {
          renderMatrix();
        }
    </script>
</body>
</html>

